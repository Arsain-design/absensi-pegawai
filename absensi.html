<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Absensi | UPTD Puskesmas Wajo</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    body {
      background: linear-gradient(to bottom right, #a8e063, #56ab2f);
    }
    video {
      transform: scaleX(-1);
    }
  </style>
</head>
<body class="text-gray-800">
  <div class="max-w-md mx-auto mt-8 bg-white shadow-lg rounded-lg p-6 text-center">
    <img src="./public/logo.png" alt="Logo" class="w-16 mx-auto mb-4" onerror="this.style.display='none'" />
    <h1 class="text-2xl font-bold text-green-700">Absensi Pegawai</h1>
    <p id="pegawaiName" class="text-sm mb-4"></p>

    <video id="video" autoplay muted playsinline class="w-full rounded mb-4"></video>

    <button id="absenBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 disabled:opacity-50" disabled>
      Mulai Absensi
    </button>

    <button id="logoutBtn" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
      Logout
    </button>

    <p id="status" class="mt-4 text-sm text-red-600 hidden"></p>
  </div>

  <script>
    const WAJO_LAT = -5.474847;
    const WAJO_LNG = 122.630311;
    const MAX_RADIUS_M = 150;

    const pegawai = JSON.parse(localStorage.getItem("pegawai"));
    if (!pegawai || !pegawai.name || !pegawai.nip) {
      window.location.href = "index.html";
    } else {
      document.getElementById("pegawaiName").textContent = `Nama: ${pegawai.name}`;
    }

    const video = document.getElementById("video");
    const absenBtn = document.getElementById("absenBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const statusText = document.getElementById("status");

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("pegawai");
      window.location.href = "index.html";
    });

    function showStatus(msg) {
      statusText.textContent = msg;
      statusText.classList.remove("hidden");
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const toRad = x => x * Math.PI / 180;
      const R = 6371e3;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function checkLocation() {
      if (!navigator.geolocation) {
        showStatus("Geolocation tidak didukung di perangkat ini.");
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        const dist = getDistance(latitude, longitude, WAJO_LAT, WAJO_LNG);
        if (dist <= MAX_RADIUS_M) {
          absenBtn.disabled = false;
        } else {
          showStatus("Anda berada di luar zona absensi (>" + Math.round(dist) + "m)");
        }
      }, (err) => {
        showStatus("Gagal mendapatkan lokasi: " + err.message);
      });
    }

    async function captureFaceSequence() {
      const detector = new faceapi.TinyFaceDetectorOptions();
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const images = [];
      const prompts = ["Menghadap Kamera", "Miring ke Kiri", "Miring ke Kanan"];

      for (let i = 0; i < 3; i++) {
        alert(`Arahkan wajah: ${prompts[i]}`);
        await new Promise(r => setTimeout(r, 2000));
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const detection = await faceapi.detectSingleFace(canvas, detector);
        if (!detection) {
          showStatus("Wajah tidak terdeteksi. Ulangi.");
          return null;
        }
        images.push(canvas.toDataURL('image/jpeg'));
      }

      return images;
    }

    absenBtn.addEventListener("click", async () => {
      absenBtn.disabled = true;
      showStatus("Memulai scan wajah...");

      const images = await captureFaceSequence();
      if (!images) {
        absenBtn.disabled = false;
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const { latitude, longitude } = pos.coords;

        try {
          const res = await fetch("https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec", {
            method: "POST",
            body: JSON.stringify({
              mode: "absensi",
              name: pegawai.name,
              nip: pegawai.nip,
              latitude,
              longitude,
              images
            }),
            headers: {
              "Content-Type": "application/json"
            }
          });

          const result = await res.json();
          if (result.status === "success") {
            alert("Absensi berhasil dicatat.");
          } else {
            showStatus(result.message || "Gagal mengirim data absensi.");
          }
        } catch (error) {
          showStatus("Terjadi kesalahan saat mengirim data.");
        }

        absenBtn.disabled = false;
      }, () => {
        showStatus("Gagal mengambil GPS.");
        absenBtn.disabled = false;
      });
    });

    async function startVideo() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        showStatus("Gagal mengakses kamera: " + err.message);
      }
    }

    async function loadModels() {
      try {
        await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/models');
      } catch (err) {
        showStatus("Gagal memuat model face-api: " + err.message);
      }
    }

    window.onload = async () => {
      await loadModels();
      await startVideo();
      checkLocation();
    };
  </script>
</body>
</html>
